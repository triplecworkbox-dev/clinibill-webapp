<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CliniBill - Clinical Billing & Reporting System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 0.95em;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }

            .header {
                padding: 30px;
            }

            .header h1 {
                font-size: 2.5em;
            }

            .header p {
                font-size: 1.1em;
            }
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex: 1 1 auto;
            min-width: 120px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .nav-tabs {
                gap: 10px;
                margin-bottom: 20px;
            }

            .nav-tab {
                padding: 15px 30px;
                font-size: 1em;
                flex: 0 1 auto;
            }
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content-section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        @media (min-width: 768px) {
            .content-section {
                padding: 30px;
            }
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        @media (min-width: 768px) {
            th {
                padding: 15px;
                font-size: 1em;
            }

            td {
                padding: 12px 15px;
                font-size: 1em;
            }
        }

        tr:hover {
            background: #f8f9ff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                margin-bottom: 30px;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-card .stat-value {
            font-size: 2em;
            font-weight: 700;
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 25px;
            }

            .stat-card h3 {
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            .stat-card .stat-value {
                font-size: 2.5em;
            }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .payment-method-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .tag-cash {
            background: #28a745;
            color: white;
        }

        .tag-card {
            background: #007bff;
            color: white;
        }

        .tag-medical-aid {
            background: #17a2b8;
            color: white;
        }

        .tag-online {
            background: #6f42c1;
            color: white;
        }

        .consultation-type-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .tag-full {
            background: #667eea;
            color: white;
        }

        .tag-discounted {
            background: #ffc107;
            color: #333;
        }

        .tag-script-only {
            background: #fd7e14;
            color: white;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .report-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .button-group .btn {
            flex: 1 1 auto;
            min-width: 150px;
        }

        @media (min-width: 768px) {
            .button-group {
                gap: 10px;
            }

            .button-group .btn {
                flex: 0 1 auto;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .modal-content {
                padding: 30px;
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-modal {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• CliniBill</h1>
            <p>Clinical Billing & Reporting System - Prototype v1.0</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('consultations')">New Consultation</button>
            <button class="nav-tab" onclick="showTab('payments')">Payment Processing</button>
            <button class="nav-tab" onclick="showTab('reports')">Reports</button>
            <button class="nav-tab" onclick="showTab('reconciliation')">Reconciliation</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <h2 style="color: #667eea; margin-bottom: 20px;">Dashboard Overview</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Today's Consultations</h3>
                    <div class="stat-value" id="todayConsults">0</div>
                </div>
                <div class="stat-card">
                    <h3>Today's Revenue</h3>
                    <div class="stat-value" id="todayRevenue">R0</div>
                </div>
                <div class="stat-card">
                    <h3>Pending Settlements</h3>
                    <div class="stat-value" id="pendingSettlements">R0</div>
                </div>
                <div class="stat-card">
                    <h3>This Week's Consultations</h3>
                    <div class="stat-value" id="weekConsults">0</div>
                </div>
            </div>

            <div class="report-section">
                <h3>Recent Consultations</h3>
                <div class="table-container">
                    <table id="recentConsultationsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Type</th>
                                <th>Payment Method</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recentConsultationsBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">No consultations recorded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Consultations Section -->
        <div id="consultations" class="content-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">New Consultation</h2>
            
            <form id="consultationForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Patient Name *</label>
                        <input type="text" id="patientName" required>
                    </div>
                    <div class="form-group">
                        <label>Patient ID/Medical Aid Number</label>
                        <input type="text" id="patientId">
                    </div>
                    <div class="form-group">
                        <label>Doctor *</label>
                        <select id="doctorSelect" required>
                            <option value="">Select Doctor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Site Location *</label>
                        <select id="siteLocation" required onchange="updatePharmacyFee()">
                            <option value="">Select Site</option>
                            <option value="lifestyle">Lifestyle Pharmacy</option>
                            <option value="vita">Vita Pharmacy</option>
                            <option value="standard">Standard Site</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Consultation Type *</label>
                        <select id="consultationType" required onchange="calculateConsultationFee()">
                            <option value="">Select Type</option>
                            <option value="full">Full Consultation (R500)</option>
                            <option value="discounted">Discounted (Pensioner/Student - 75-80% off)</option>
                            <option value="script-only">Script Only (50% off)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select id="paymentMethod" required>
                            <option value="">Select Payment Method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="medical-aid">Medical Aid</option>
                            <option value="online">Online Payment</option>
                            <option value="qr-code">QR Code</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ICD-10 Code</label>
                        <input type="text" id="icd10Code" placeholder="e.g., J06.9">
                    </div>
                    <div class="form-group">
                        <label>Discount Percentage (if applicable)</label>
                        <input type="number" id="discountPercent" min="0" max="100" value="0" onchange="calculateConsultationFee()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="consultationNotes" rows="4"></textarea>
                </div>

                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Fee Breakdown</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Consultation Fee:</strong>
                            <div id="consultationFeeDisplay" style="font-size: 1.5em; color: #667eea; font-weight: 700;">R0</div>
                        </div>
                        <div>
                            <strong>Doctor Payment:</strong>
                            <div id="doctorPaymentDisplay" style="font-size: 1.5em; color: #28a745; font-weight: 700;">R0</div>
                        </div>
                        <div>
                            <strong>Pharmacy Fee:</strong>
                            <div id="pharmacyFeeDisplay" style="font-size: 1.5em; color: #17a2b8; font-weight: 700;">R0</div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn">Save Consultation</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('consultationForm').reset(); calculateConsultationFee();">Clear Form</button>
                </div>
            </form>
        </div>

        <!-- Payment Processing Section -->
        <div id="payments" class="content-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">Payment Processing</h2>
            
            <div class="report-section">
                <h3>Pending Payments</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="pendingPaymentsBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #999;">No pending payments</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="report-section">
                <h3>Payment History</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="paymentHistoryBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">No payment history</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">Reports & Analytics</h2>

            <div class="button-group">
                <button class="btn" onclick="generateDailyReport()">Generate Daily Activity Report</button>
                <button class="btn" onclick="generateWeeklyReport()">Generate Weekly Reconciliation</button>
                <button class="btn" onclick="generateMonthlyReport()">Generate Monthly Payment Report</button>
                <button class="btn btn-secondary" onclick="exportToCSV()">Export to CSV</button>
            </div>

            <div id="reportOutput" style="margin-top: 30px;"></div>
        </div>

        <!-- Reconciliation Section -->
        <div id="reconciliation" class="content-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">Weekly Reconciliation</h2>
            
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Reconciliation Due:</strong> Next reconciliation report due Thursday night/Friday morning
            </div>

            <div class="report-section">
                <h3>Doctor Settlements Summary</h3>
                <div class="table-container">
                    <table id="doctorSettlementsTable">
                        <thead>
                            <tr>
                                <th>Doctor Name</th>
                                <th>Consultations</th>
                                <th>Total Owed (R350 per consult)</th>
                                <th>Payment Status</th>
                            </tr>
                        </thead>
                        <tbody id="doctorSettlementsBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999;">No settlements to display</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="report-section">
                <h3>Pharmacy Settlements Summary</h3>
                <div class="table-container">
                    <table id="pharmacySettlementsTable">
                        <thead>
                            <tr>
                                <th>Site Location</th>
                                <th>Full Consultations</th>
                                <th>Discounted Consultations</th>
                                <th>Total Owed</th>
                            </tr>
                        </thead>
                        <tbody id="pharmacySettlementsBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999;">No pharmacy settlements</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="processWeeklySettlement()">Process Weekly Settlement</button>
                <button class="btn btn-secondary" onclick="downloadReconciliationReport()">Download Report</button>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">System Settings</h2>

            <div class="report-section">
                <h3>Manage Doctors</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Doctor Name</label>
                        <input type="text" id="newDoctorName">
                    </div>
                    <div class="form-group">
                        <label>Consultation Rate (R)</label>
                        <input type="number" id="newDoctorRate" value="350">
                    </div>
                </div>
                <button class="btn" onclick="addDoctor()">Add Doctor</button>

                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Doctor Name</th>
                                <th>Consultation Rate</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="doctorsListBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="report-section">
                <h3>Fee Configuration</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Base Consultation Fee (R)</label>
                        <input type="number" id="baseConsultationFee" value="500">
                    </div>
                    <div class="form-group">
                        <label>Doctor Payment per Consultation (R)</label>
                        <input type="number" id="doctorPaymentRate" value="350">
                    </div>
                    <div class="form-group">
                        <label>Lifestyle Pharmacy Fee (R)</label>
                        <input type="number" id="lifestylePharmacyFee" value="50">
                    </div>
                    <div class="form-group">
                        <label>Vita Pharmacy Fee (R)</label>
                        <input type="number" id="vitaPharmacyFee" value="100">
                    </div>
                    <div class="form-group">
                        <label>Standard Pharmacy Fee (R)</label>
                        <input type="number" id="standardPharmacyFee" value="50">
                    </div>
                    <div class="form-group">
                        <label>Discounted Consultation Pharmacy Fee (R)</label>
                        <input type="number" id="discountedPharmacyFee" value="30">
                    </div>
                </div>
                <button class="btn" onclick="saveFeeConfiguration()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('successModal')">&times;</span>
                <h2>‚úÖ Success</h2>
            </div>
            <p id="successMessage"></p>
            <button class="btn" onclick="closeModal('successModal')" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <script>
        // Data Storage
        let consultations = [];
        let doctors = [
            { id: 1, name: "Dr. Smith", rate: 350, active: true },
            { id: 2, name: "Dr. Johnson", rate: 350, active: true },
            { id: 3, name: "Dr. Williams", rate: 350, active: true }
        ];
        let nextDoctorId = 4;
        let nextConsultationId = 1;

        // Fee Configuration
        let feeConfig = {
            baseConsultationFee: 500,
            doctorPaymentRate: 350,
            lifestylePharmacyFee: 50,
            vitaPharmacyFee: 100,
            standardPharmacyFee: 50,
            discountedPharmacyFee: 30
        };

        // Initialize Sample Data
        function initializeSampleData() {
            const now = new Date();
            const sampleData = [
                {
                    id: nextConsultationId++,
                    timestamp: new Date(now.getTime() - 3 * 60 * 60 * 1000), // 3 hours ago
                    patientName: "John Doe",
                    patientId: "MA12345",
                    doctor: "Dr. Smith",
                    doctorId: 1,
                    siteLocation: "lifestyle",
                    consultationType: "full",
                    paymentMethod: "card",
                    icd10Code: "J06.9",
                    notes: "Upper respiratory infection",
                    consultationFee: 500,
                    doctorPayment: 350,
                    pharmacyFee: 50,
                    paymentStatus: "completed"
                },
                {
                    id: nextConsultationId++,
                    timestamp: new Date(now.getTime() - 2 * 60 * 60 * 1000), // 2 hours ago
                    patientName: "Sarah Johnson",
                    patientId: "MA67890",
                    doctor: "Dr. Johnson",
                    doctorId: 2,
                    siteLocation: "vita",
                    consultationType: "discounted",
                    paymentMethod: "medical-aid",
                    icd10Code: "M79.3",
                    notes: "Senior patient - arthritis consultation",
                    consultationFee: 100,
                    doctorPayment: 350,
                    pharmacyFee: 30,
                    paymentStatus: "pending"
                },
                {
                    id: nextConsultationId++,
                    timestamp: new Date(now.getTime() - 1.5 * 60 * 60 * 1000), // 1.5 hours ago
                    patientName: "Michael Brown",
                    patientId: "CASH001",
                    doctor: "Dr. Williams",
                    doctorId: 3,
                    siteLocation: "standard",
                    consultationType: "script-only",
                    paymentMethod: "cash",
                    icd10Code: "E11.9",
                    notes: "Diabetes prescription refill",
                    consultationFee: 250,
                    doctorPayment: 350,
                    pharmacyFee: 30,
                    paymentStatus: "completed"
                },
                {
                    id: nextConsultationId++,
                    timestamp: new Date(now.getTime() - 45 * 60 * 1000), // 45 minutes ago
                    patientName: "Emily Davis",
                    patientId: "OL98765",
                    doctor: "Dr. Smith",
                    doctorId: 1,
                    siteLocation: "lifestyle",
                    consultationType: "full",
                    paymentMethod: "online",
                    icd10Code: "R50.9",
                    notes: "Flu symptoms",
                    consultationFee: 500,
                    doctorPayment: 350,
                    pharmacyFee: 50,
                    paymentStatus: "completed"
                }
            ];

            consultations = sampleData;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSampleData();
            loadDoctors();
            updateDashboard();
            loadFeeConfiguration();
        });

        // Tab Navigation
        function showTab(tabName) {
            const sections = document.querySelectorAll('.content-section');
            const tabs = document.querySelectorAll('.nav-tab');
            
            sections.forEach(section => section.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'reconciliation') {
                updateReconciliationData();
            }
        }

        // Load Doctors into Select
        function loadDoctors() {
            const select = document.getElementById('doctorSelect');
            const tbody = document.getElementById('doctorsListBody');
            
            select.innerHTML = '<option value="">Select Doctor</option>';
            tbody.innerHTML = '';
            
            doctors.forEach(doctor => {
                if (doctor.active) {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = doctor.name;
                    select.appendChild(option);
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${doctor.name}</td>
                    <td>R${doctor.rate}</td>
                    <td>${doctor.active ? '‚úÖ Active' : '‚ùå Inactive'}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.9em;" 
                                onclick="toggleDoctorStatus(${doctor.id})">
                            ${doctor.active ? 'Deactivate' : 'Activate'}
                        </button>
                    </td>
                `;
            });
        }

        // Add New Doctor
        function addDoctor() {
            const name = document.getElementById('newDoctorName').value;
            const rate = parseFloat(document.getElementById('newDoctorRate').value);

            if (!name) {
                alert('Please enter doctor name');
                return;
            }

            doctors.push({
                id: nextDoctorId++,
                name: name,
                rate: rate || 350,
                active: true
            });

            document.getElementById('newDoctorName').value = '';
            document.getElementById('newDoctorRate').value = '350';
            
            loadDoctors();
            showSuccessMessage('Doctor added successfully!');
        }

        // Toggle Doctor Status
        function toggleDoctorStatus(doctorId) {
            const doctor = doctors.find(d => d.id === doctorId);
            if (doctor) {
                doctor.active = !doctor.active;
                loadDoctors();
                showSuccessMessage(`Doctor ${doctor.active ? 'activated' : 'deactivated'} successfully!`);
            }
        }

        // Calculate Consultation Fee
        function calculateConsultationFee() {
            const consultationType = document.getElementById('consultationType').value;
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const siteLocation = document.getElementById('siteLocation').value;

            let consultationFee = feeConfig.baseConsultationFee;
            let doctorPayment = feeConfig.doctorPaymentRate;
            let pharmacyFee = feeConfig.standardPharmacyFee;

            if (consultationType === 'discounted') {
                consultationFee = feeConfig.baseConsultationFee * 0.2; // 80% off
                pharmacyFee = feeConfig.discountedPharmacyFee;
            } else if (consultationType === 'script-only') {
                consultationFee = feeConfig.baseConsultationFee * 0.5; // 50% off
                pharmacyFee = feeConfig.discountedPharmacyFee;
            }

            if (discountPercent > 0) {
                consultationFee = consultationFee * (1 - discountPercent / 100);
            }

            // Update pharmacy fee based on location
            if (siteLocation === 'lifestyle') {
                pharmacyFee = consultationType === 'full' ? feeConfig.lifestylePharmacyFee : feeConfig.discountedPharmacyFee;
            } else if (siteLocation === 'vita') {
                pharmacyFee = consultationType === 'full' ? feeConfig.vitaPharmacyFee : feeConfig.discountedPharmacyFee;
            }

            document.getElementById('consultationFeeDisplay').textContent = `R${consultationFee.toFixed(2)}`;
            document.getElementById('doctorPaymentDisplay').textContent = `R${doctorPayment.toFixed(2)}`;
            document.getElementById('pharmacyFeeDisplay').textContent = `R${pharmacyFee.toFixed(2)}`;
        }

        // Update Pharmacy Fee based on location
        function updatePharmacyFee() {
            calculateConsultationFee();
        }

        // Handle Consultation Form Submit
        document.getElementById('consultationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const patientName = document.getElementById('patientName').value;
            const patientId = document.getElementById('patientId').value;
            const doctorId = parseInt(document.getElementById('doctorSelect').value);
            const siteLocation = document.getElementById('siteLocation').value;
            const consultationType = document.getElementById('consultationType').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const icd10Code = document.getElementById('icd10Code').value;
            const notes = document.getElementById('consultationNotes').value;

            const doctor = doctors.find(d => d.id === doctorId);
            
            const consultationFee = parseFloat(document.getElementById('consultationFeeDisplay').textContent.replace('R', ''));
            const doctorPayment = parseFloat(document.getElementById('doctorPaymentDisplay').textContent.replace('R', ''));
            const pharmacyFee = parseFloat(document.getElementById('pharmacyFeeDisplay').textContent.replace('R', ''));

            const consultation = {
                id: nextConsultationId++,
                timestamp: new Date(),
                patientName: patientName,
                patientId: patientId,
                doctor: doctor.name,
                doctorId: doctorId,
                siteLocation: siteLocation,
                consultationType: consultationType,
                paymentMethod: paymentMethod,
                icd10Code: icd10Code,
                notes: notes,
                consultationFee: consultationFee,
                doctorPayment: doctorPayment,
                pharmacyFee: pharmacyFee,
                paymentStatus: paymentMethod === 'medical-aid' ? 'pending' : 'completed'
            };

            consultations.push(consultation);
            
            showSuccessMessage('Consultation saved successfully!');
            document.getElementById('consultationForm').reset();
            calculateConsultationFee();
            updateDashboard();
        });

        // Update Dashboard
        function updateDashboard() {
            const today = new Date().toDateString();
            const todayConsultations = consultations.filter(c => new Date(c.timestamp).toDateString() === today);
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekConsultations = consultations.filter(c => new Date(c.timestamp) >= weekStart);

            const todayRevenue = todayConsultations.reduce((sum, c) => sum + c.consultationFee, 0);
            const pendingSettlements = consultations
                .filter(c => c.paymentStatus === 'pending')
                .reduce((sum, c) => sum + c.consultationFee, 0);

            document.getElementById('todayConsults').textContent = todayConsultations.length;
            document.getElementById('todayRevenue').textContent = `R${todayRevenue.toFixed(2)}`;
            document.getElementById('pendingSettlements').textContent = `R${pendingSettlements.toFixed(2)}`;
            document.getElementById('weekConsults').textContent = weekConsultations.length;

            // Update recent consultations table
            const tbody = document.getElementById('recentConsultationsBody');
            tbody.innerHTML = '';

            if (consultations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No consultations recorded yet</td></tr>';
            } else {
                const recent = consultations.slice(-10).reverse();
                recent.forEach(consultation => {
                    const row = tbody.insertRow();
                    const time = new Date(consultation.timestamp).toLocaleTimeString();
                    
                    row.innerHTML = `
                        <td>${time}</td>
                        <td>${consultation.patientName}</td>
                        <td>${consultation.doctor}</td>
                        <td><span class="consultation-type-tag tag-${consultation.consultationType}">${formatConsultationType(consultation.consultationType)}</span></td>
                        <td><span class="payment-method-tag tag-${consultation.paymentMethod}">${formatPaymentMethod(consultation.paymentMethod)}</span></td>
                        <td>R${consultation.consultationFee.toFixed(2)}</td>
                    `;
                });
            }
        }

        // Format Consultation Type
        function formatConsultationType(type) {
            const types = {
                'full': 'Full',
                'discounted': 'Discounted',
                'script-only': 'Script Only'
            };
            return types[type] || type;
        }

        // Format Payment Method
        function formatPaymentMethod(method) {
            const methods = {
                'cash': 'Cash',
                'card': 'Card',
                'medical-aid': 'Medical Aid',
                'online': 'Online',
                'qr-code': 'QR Code'
            };
            return methods[method] || method;
        }

        // Generate Daily Report
        function generateDailyReport() {
            const today = new Date().toDateString();
            const todayConsultations = consultations.filter(c => new Date(c.timestamp).toDateString() === today);

            let reportHTML = `
                <div class="report-section">
                    <h3>Daily Activity Report - ${new Date().toLocaleDateString()}</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Patient Name</th>
                                    <th>Doctor</th>
                                    <th>ICD-10 Code</th>
                                    <th>Consultation Type</th>
                                    <th>Payment Method</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            if (todayConsultations.length === 0) {
                reportHTML += '<tr><td colspan="7" style="text-align: center;">No consultations today</td></tr>';
            } else {
                todayConsultations.forEach(c => {
                    reportHTML += `
                        <tr>
                            <td>${new Date(c.timestamp).toLocaleTimeString()}</td>
                            <td>${c.patientName}</td>
                            <td>${c.doctor}</td>
                            <td>${c.icd10Code || 'N/A'}</td>
                            <td>${formatConsultationType(c.consultationType)}</td>
                            <td>${formatPaymentMethod(c.paymentMethod)}</td>
                            <td>R${c.consultationFee.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }

            const totalRevenue = todayConsultations.reduce((sum, c) => sum + c.consultationFee, 0);

            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                        <strong>Total Consultations:</strong> ${todayConsultations.length}<br>
                        <strong>Total Revenue:</strong> R${totalRevenue.toFixed(2)}
                    </div>
                </div>
            `;

            document.getElementById('reportOutput').innerHTML = reportHTML;
        }

        // Generate Weekly Report
        function generateWeeklyReport() {
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekConsultations = consultations.filter(c => new Date(c.timestamp) >= weekStart);

            let reportHTML = `
                <div class="report-section">
                    <h3>Weekly Reconciliation Report</h3>
                    <p style="color: #666; margin-bottom: 20px;">Week starting ${weekStart.toLocaleDateString()}</p>
            `;

            // Group by doctor
            const doctorStats = {};
            weekConsultations.forEach(c => {
                if (!doctorStats[c.doctor]) {
                    doctorStats[c.doctor] = { count: 0, owed: 0 };
                }
                doctorStats[c.doctor].count++;
                doctorStats[c.doctor].owed += c.doctorPayment;
            });

            reportHTML += `
                <h4>Doctor Settlements</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Doctor</th>
                                <th>Consultations</th>
                                <th>Total Owed (R350 √ó count)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            for (const [doctor, stats] of Object.entries(doctorStats)) {
                reportHTML += `
                    <tr>
                        <td>${doctor}</td>
                        <td>${stats.count}</td>
                        <td>R${stats.owed.toFixed(2)}</td>
                    </tr>
                `;
            }

            const totalDoctorSettlement = Object.values(doctorStats).reduce((sum, s) => sum + s.owed, 0);

            reportHTML += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                    <strong>Total Doctor Settlements:</strong> R${totalDoctorSettlement.toFixed(2)}
                </div>
                </div>
            `;

            document.getElementById('reportOutput').innerHTML = reportHTML;
        }

        // Generate Monthly Report
        function generateMonthlyReport() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthConsultations = consultations.filter(c => {
                const date = new Date(c.timestamp);
                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
            });

            let reportHTML = `
                <div class="report-section">
                    <h3>Monthly Payment Report - ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
            `;

            // Payment method breakdown
            const paymentBreakdown = {};
            monthConsultations.forEach(c => {
                if (!paymentBreakdown[c.paymentMethod]) {
                    paymentBreakdown[c.paymentMethod] = { count: 0, total: 0 };
                }
                paymentBreakdown[c.paymentMethod].count++;
                paymentBreakdown[c.paymentMethod].total += c.consultationFee;
            });

            reportHTML += `
                <h4>Payment Method Breakdown</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Payment Method</th>
                                <th>Count</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            for (const [method, stats] of Object.entries(paymentBreakdown)) {
                reportHTML += `
                    <tr>
                        <td>${formatPaymentMethod(method)}</td>
                        <td>${stats.count}</td>
                        <td>R${stats.total.toFixed(2)}</td>
                    </tr>
                `;
            }

            const totalRevenue = monthConsultations.reduce((sum, c) => sum + c.consultationFee, 0);
            const totalDoctorPayments = monthConsultations.reduce((sum, c) => sum + c.doctorPayment, 0);
            const totalPharmacyPayments = monthConsultations.reduce((sum, c) => sum + c.pharmacyFee, 0);

            reportHTML += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                    <strong>Total Consultations:</strong> ${monthConsultations.length}<br>
                    <strong>Total Revenue:</strong> R${totalRevenue.toFixed(2)}<br>
                    <strong>Total Doctor Payments:</strong> R${totalDoctorPayments.toFixed(2)}<br>
                    <strong>Total Pharmacy Payments:</strong> R${totalPharmacyPayments.toFixed(2)}<br>
                    <strong>Net Revenue:</strong> R${(totalRevenue - totalDoctorPayments - totalPharmacyPayments).toFixed(2)}
                </div>
                </div>
            `;

            document.getElementById('reportOutput').innerHTML = reportHTML;
        }

        // Update Reconciliation Data
        function updateReconciliationData() {
            // Doctor settlements
            const doctorStats = {};
            consultations.forEach(c => {
                if (!doctorStats[c.doctor]) {
                    doctorStats[c.doctor] = { count: 0, owed: 0 };
                }
                doctorStats[c.doctor].count++;
                doctorStats[c.doctor].owed += c.doctorPayment;
            });

            const doctorTbody = document.getElementById('doctorSettlementsBody');
            doctorTbody.innerHTML = '';

            if (Object.keys(doctorStats).length === 0) {
                doctorTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No settlements to display</td></tr>';
            } else {
                for (const [doctor, stats] of Object.entries(doctorStats)) {
                    const row = doctorTbody.insertRow();
                    row.innerHTML = `
                        <td>${doctor}</td>
                        <td>${stats.count}</td>
                        <td>R${stats.owed.toFixed(2)}</td>
                        <td><span style="color: orange; font-weight: 600;">‚è≥ Pending</span></td>
                    `;
                }
            }

            // Pharmacy settlements
            const pharmacyStats = {};
            consultations.forEach(c => {
                if (!pharmacyStats[c.siteLocation]) {
                    pharmacyStats[c.siteLocation] = { full: 0, discounted: 0, total: 0 };
                }
                if (c.consultationType === 'full') {
                    pharmacyStats[c.siteLocation].full++;
                } else {
                    pharmacyStats[c.siteLocation].discounted++;
                }
                pharmacyStats[c.siteLocation].total += c.pharmacyFee;
            });

            const pharmacyTbody = document.getElementById('pharmacySettlementsBody');
            pharmacyTbody.innerHTML = '';

            if (Object.keys(pharmacyStats).length === 0) {
                pharmacyTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No pharmacy settlements</td></tr>';
            } else {
                for (const [location, stats] of Object.entries(pharmacyStats)) {
                    const row = pharmacyTbody.insertRow();
                    row.innerHTML = `
                        <td>${formatSiteLocation(location)}</td>
                        <td>${stats.full}</td>
                        <td>${stats.discounted}</td>
                        <td>R${stats.total.toFixed(2)}</td>
                    `;
                }
            }
        }

        // Format Site Location
        function formatSiteLocation(location) {
            const locations = {
                'lifestyle': 'Lifestyle Pharmacy',
                'vita': 'Vita Pharmacy',
                'standard': 'Standard Site'
            };
            return locations[location] || location;
        }

        // Process Weekly Settlement
        function processWeeklySettlement() {
            showSuccessMessage('Weekly settlement processed successfully! Payment instructions have been generated.');
            updateReconciliationData();
        }

        // Download Reconciliation Report
        function downloadReconciliationReport() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "CliniBill Weekly Reconciliation Report\n\n";
            csvContent += "Doctor,Consultations,Amount Owed\n";

            const doctorStats = {};
            consultations.forEach(c => {
                if (!doctorStats[c.doctor]) {
                    doctorStats[c.doctor] = { count: 0, owed: 0 };
                }
                doctorStats[c.doctor].count++;
                doctorStats[c.doctor].owed += c.doctorPayment;
            });

            for (const [doctor, stats] of Object.entries(doctorStats)) {
                csvContent += `${doctor},${stats.count},R${stats.owed.toFixed(2)}\n`;
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `reconciliation_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export to CSV
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Time,Patient,Doctor,Consultation Type,Payment Method,Amount,ICD-10\n";

            consultations.forEach(c => {
                const date = new Date(c.timestamp).toLocaleDateString();
                const time = new Date(c.timestamp).toLocaleTimeString();
                csvContent += `${date},${time},${c.patientName},${c.doctor},${formatConsultationType(c.consultationType)},${formatPaymentMethod(c.paymentMethod)},R${c.consultationFee.toFixed(2)},${c.icd10Code || 'N/A'}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `clinibill_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccessMessage('Data exported to CSV successfully!');
        }

        // Save Fee Configuration
        function saveFeeConfiguration() {
            feeConfig.baseConsultationFee = parseFloat(document.getElementById('baseConsultationFee').value);
            feeConfig.doctorPaymentRate = parseFloat(document.getElementById('doctorPaymentRate').value);
            feeConfig.lifestylePharmacyFee = parseFloat(document.getElementById('lifestylePharmacyFee').value);
            feeConfig.vitaPharmacyFee = parseFloat(document.getElementById('vitaPharmacyFee').value);
            feeConfig.standardPharmacyFee = parseFloat(document.getElementById('standardPharmacyFee').value);
            feeConfig.discountedPharmacyFee = parseFloat(document.getElementById('discountedPharmacyFee').value);

            showSuccessMessage('Fee configuration saved successfully!');
        }

        // Load Fee Configuration
        function loadFeeConfiguration() {
            document.getElementById('baseConsultationFee').value = feeConfig.baseConsultationFee;
            document.getElementById('doctorPaymentRate').value = feeConfig.doctorPaymentRate;
            document.getElementById('lifestylePharmacyFee').value = feeConfig.lifestylePharmacyFee;
            document.getElementById('vitaPharmacyFee').value = feeConfig.vitaPharmacyFee;
            document.getElementById('standardPharmacyFee').value = feeConfig.standardPharmacyFee;
            document.getElementById('discountedPharmacyFee').value = feeConfig.discountedPharmacyFee;
        }

        // Show Success Message
        function showSuccessMessage(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('active');
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
    </script>
</body>
</html>
